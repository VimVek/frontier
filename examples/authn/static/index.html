<!DOCTYPE html>
<head>
	<link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.*/css/pico.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
</head>
<body>
	<main class="container">
		<header>
			<div>
				<h1>
					{{ .page }} | {{ .title }}
				</h1>
			</div>
			<div>
				<nav>
					<ul>
						<li><a href="/passkeyauth">PassKey</a></li>
						<li><a href="/">Home</a></li>
						<li><a href="/login">Login/Register</a></li>
						<li><a href="/logout">Logout</a></li>
						<li><a href="/profile">Profile</a></li>
						<li><a href="/token">Stateless Profile via Client Credentials</a></li>
					</ul>
				</nav>
			</div>
		</header>
		<hr>
		<div>
			{{ .content }}
		</div>
	</main>
	<script>
		$(document).ready(function () {
			if (!window.PublicKeyCredential) {
				alert("Error: this browser does not support WebAuthn");
				return;
			}
		});
		function registerUser() {
			username = $("#email").val()
			if (username === "") {
				alert("please enter a username");   
				return;
			}
			$.get(
				'http://localhost:6050/register/begin/' + username,
				null,
				function (data) {
					return data
				},
				'json').then((credentialCreationOptions) => {
					console.log("Before Register begin",credentialCreationOptions)
					credentialCreationOptions.publicKey.challenge = bufferDecode(credentialCreationOptions.publicKey.challenge);
					credentialCreationOptions.publicKey.user.id = bufferDecode(credentialCreationOptions.publicKey.user.id);
					console.log("After Register begin",credentialCreationOptions)
					return navigator.credentials.create({
						publicKey: credentialCreationOptions.publicKey
					})
				}).then((credential) => {
					console.log("Before ATTESTATION begin",credential)
					let attestationObject = credential.response.attestationObject;
					let clientDataJSON = credential.response.clientDataJSON;
					let rawId = credential.rawId;
					console.log("after ATTESTATION begin",credential)
					$.post(
						'http://localhost:6050/register/finish/' + username,
						JSON.stringify({
							id: credential.id,
							type: credential.type,
							rawId: bufferEncode(rawId),
							response: {
								attestationObject: bufferEncode(attestationObject),
								clientDataJSON: bufferEncode(clientDataJSON),
							},
						}), function (data) {
							console.log("data",data)
							return data
						},
						'json').then((success) => {
							alert("successfully registered " + username + "!")
							return
						}).catch((err) => {
							console.log(err)
							alert("failed to post register " + username)
						})

				}).catch((err) => {
					console.log(err)
					alert("failed to register " + username)
				})
		}
		async function loginUser() {
			username = $("#email").val()
			if (username === "") {
				alert("please enter a username");
				return;
			}
			const response = await fetch('http://localhost:6050/login/begin/' + username)
			response.json()
				.then((credentialRequestOptions) => {
					credentialRequestOptions.publicKey.challenge = bufferDecode(credentialRequestOptions.publicKey.challenge);
					credentialRequestOptions.publicKey.allowCredentials.forEach(function (listItem, idx) {
						credentialRequestOptions.publicKey.allowCredentials[idx].id = base64urlToBuffer(listItem.id)
					});
					return navigator.credentials.get({
						publicKey: credentialRequestOptions.publicKey
					})
				}).then((assertion) => {
					let authData = assertion.response.authenticatorData;
					let clientDataJSON = assertion.response.clientDataJSON;
					let rawId = assertion.rawId;
					let sig = assertion.response.signature;
					let userHandle = assertion.response.userHandle;
					let finishBody = JSON.stringify({
							id: assertion.id,
							rawId: bufferEncode(rawId),
							type: assertion.type,
							response: {
								authenticatorData: bufferEncode(authData),
								clientDataJSON: bufferEncode(clientDataJSON),
								signature: bufferEncode(sig),
								userHandle: bufferEncode(userHandle),
							},
						})
					$.post(
						'http://localhost:6050/login/finish/' + username,
						{
							"body": finishBody,
						},
						function (data) {
							return data
						},
						'json')
				}).then((success) => {
					alert("successfully logged in " + username + "!")
					return
				}).catch((error) => {
					console.log(error)
					alert("failed to register " + username)
				})
		}
		function base64urlToBuffer(baseurl64String) {
			// Base64url to Base64
			const padding = "==".slice(0, (4 - (baseurl64String.length % 4)) % 4);
			const base64String =
				baseurl64String.replace(/-/g, "+").replace(/_/g, "/") + padding;
			// Base64 to binary string
			const str = atob(base64String);
			// Binary string to buffer
			///localhost:6050/login/finish/
			const buffer = new ArrayBuffer(str.length);
			const byteView = new Uint8Array(buffer);
			for (let i = 0; i < str.length; i++) {
				byteView[i] = str.charCodeAt(i);
			}
			return buffer;
		} 
		function bufferDecode(value) {
			return Uint8Array.from(value, c => c.charCodeAt(0));
		}
		function bufferEncode(value) {
			return btoa(String.fromCharCode.apply(null, new Uint8Array(value)))
				.replace(/\+/g, "-")
				.replace(/\//g, "_")
				.replace(/=/g, "");;
		}
	</script>
</body>

</html>
